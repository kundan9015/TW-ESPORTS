{% extends "base.html" %}

{% block title %}Upload Match Record{% endblock %}

{% block head %}
<script src="{{ url_for('static', filename='js/stats.js') }}"></script>
{% endblock %}

{% block content %}
<h1 class="neon-title mb-6">üì§ Upload Match Record</h1>

<div class="row">
  <div class="col-lg-6">
    <div class="glass-card">
      <h3 class="neon-title mb-3">Match Stats</h3>
      <form id="statsForm" method="POST" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="date" class="form-label">Date</label>
          <input type="date" class="form-control" id="date" name="date" required>
        </div>

        <div class="row">
          <div class="col-6">
            <div class="mb-3">
              <label for="kills" class="form-label">Kills</label>
              <input type="number" class="form-control" id="kills" name="kills" required>
            </div>
          </div>
          <div class="col-6">
            <div class="mb-3">
              <label for="booyah" class="form-label">Booyah</label>
              <input type="number" class="form-control" id="booyah" name="booyah" required>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-6">
            <div class="mb-3">
              <label for="damage" class="form-label">Damage</label>
              <input type="number" class="form-control" id="damage" name="damage" required>
            </div>
          </div>
          <div class="col-6">
            <div class="mb-3">
              <label for="survival" class="form-label">Survival (min)</label>
              <input type="number" class="form-control" id="survival" name="survival" required>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Screenshot</label>
          <div class="dropzone" id="dropzone">
            <input type="file" class="form-control" id="screenshot" name="screenshot" required style="display:none;">
            <div style="padding: 20px; text-align: center; cursor: pointer;">
              <div style="font-size: 28px; margin-bottom: 8px;">üñºÔ∏è</div>
              <div style="color: var(--accent-primary); font-weight: 600;">Drag & drop or click to upload</div>
              <div class="muted small" style="margin-top: 4px;">PNG, JPG, JPEG, GIF (max 10MB)</div>
            </div>
            <img id="previewImg" style="max-width: 100%; border-radius: 8px; margin-top: 12px; display: none;">
          </div>
        </div>

        <button type="submit" class="btn-neon w-100">‚úÖ Submit Record</button>
      </form>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="glass-card">
      <h3 class="neon-title mb-3">üìä Your Match History</h3>
      <div style="max-height: 500px; overflow-y: auto;">
        <table id="historyTable" style="width: 100%; font-size: 14px;">
          <thead>
            <tr style="color: var(--accent-primary); border-bottom: 1px solid rgba(255,255,255,0.04);">
              <th style="text-align: left; padding: 8px;">Date</th>
              <th style="text-align: right; padding: 8px;">Kills</th>
              <th style="text-align: right; padding: 8px;">Booyah</th>
              <th style="text-align: right; padding: 8px;">DMG</th>
              <th style="text-align: right; padding: 8px;">Surv</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// Dropzone functionality
const dropzone = document.getElementById('dropzone');
const fileInput = document.getElementById('screenshot');
const previewImg = document.getElementById('previewImg');

dropzone.addEventListener('click', () => fileInput.click());
dropzone.addEventListener('dragover', (e) => {
  e.preventDefault();
  dropzone.style.borderColor = 'rgba(34,197,94,0.5)';
});
dropzone.addEventListener('dragleave', () => {
  dropzone.style.borderColor = 'rgba(255,255,255,0.04)';
});
dropzone.addEventListener('drop', (e) => {
  e.preventDefault();
  if(e.dataTransfer.files.length) {
    fileInput.files = e.dataTransfer.files;
    showPreview();
  }
  dropzone.style.borderColor = 'rgba(255,255,255,0.04)';
});

fileInput.addEventListener('change', showPreview);

function showPreview() {
  const file = fileInput.files[0];
  if(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      previewImg.src = e.target.result;
      previewImg.style.display = 'block';
    };
    reader.readAsDataURL(file);
  }
}

// Load match history
async function loadHistory() {
  const res = await fetch('/api/my_stats');
  const data = await res.json();
  const tbody = document.querySelector('#historyTable tbody');
  tbody.innerHTML = '';
  data.forEach(record => {
    const row = tbody.insertRow();
    row.style.borderBottom = '1px solid rgba(255,255,255,0.02)';
    row.innerHTML = `
      <td style="padding: 8px;">${record.date}</td>
      <td style="padding: 8px; text-align: right; color: var(--accent-primary);">${record.kills}</td>
      <td style="padding: 8px; text-align: right; color: var(--cyan-glow);">${record.booyah}</td>
      <td style="padding: 8px; text-align: right;">${record.damage}</td>
      <td style="padding: 8px; text-align: right;">${record.survival}</td>
    `;
  });
}

loadHistory();
</script>
{% endblock %}
