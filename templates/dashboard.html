{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="mb-4">
    <h1 class="neon-title" style="font-size: 2.4rem;">Welcome, {{ user.username }}! ğŸ®</h1>
    <p class="muted">{{ user.role | title }} â€¢ {{ user.ff_uid if user.ff_uid else 'No UID set' }}</p>
</div>

{% if note %}
<div class="glass-card" style="border-left: 4px solid var(--accent-primary); background: linear-gradient(90deg, rgba(34,255,136,0.08), rgba(34,255,136,0.04)); margin-bottom: 20px;">
  <div style="display: flex; align-items: center; gap: 12px;">
    <span style="font-size: 20px;">ğŸ””</span>
    <div>
      <div style="color: var(--accent-primary); font-weight: 600;">Practice Notice</div>
      <div style="color: var(--text-primary); margin-top: 4px;">{{ note.message }}</div>
      <div class="muted small" style="margin-top: 6px;">{{ note.date }} at {{ note.time }}</div>
    </div>
  </div>
</div>
{% endif %}

{% if notifications %}
<div class="glass-card mb-3" style="border-left: 4px solid var(--cyan-glow);">
  <div style="color: var(--cyan-glow); font-weight: 600;">ğŸ“¢ Notifications</div>
  <ul class="list-unstyled mb-0 mt-2" style="text-align: left;">
    {% for n in notifications %}
    <li class="d-flex justify-content-between align-items-center py-2" style="border-bottom: 1px solid rgba(255,255,255,0.06);">
      <span style="color: var(--text-primary);">{{ n.message }}</span>
      {% if user.role == 'admin' %}
      <form method="POST" action="{{ url_for('notification_delete', nid=n.id) }}" class="d-inline" onsubmit="return confirm('Delete this notification?');">
        <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
      </form>
      {% endif %}
    </li>
    {% endfor %}
  </ul>
</div>
{% endif %}

{% if user.role == 'admin' %}
<div class="glass-card mb-4">
  <div style="color: var(--accent-primary); font-weight: 600;">â• Add Notification</div>
  <form method="POST" action="{{ url_for('notification_add') }}" class="mt-2 d-flex gap-2 flex-wrap">
    <input type="text" name="message" class="form-control" placeholder="Type notification / reminder..." style="max-width: 400px;">
    <button type="submit" class="btn btn-success">Send</button>
  </form>
</div>
{% endif %}

<div class="glass-grid" style="margin-bottom: 24px;">
  {% if user_stats %}
    <div class="glass-card">
      <div class="muted small">Total Matches</div>
      <div style="font-size: 2rem; color: var(--accent-primary); font-weight: 700; margin-top: 8px;">{{ user_stats.matches }}</div>
    </div>
    <div class="glass-card">
      <div class="muted small">Total Kills</div>
      <div style="font-size: 2rem; color: var(--cyan-glow); font-weight: 700; margin-top: 8px;">{{ user_stats.kills }}</div>
    </div>
  {% endif %}
  <div class="glass-card">
    <div class="muted small">Your Best Kills</div>
    <div style="font-size: 2rem; color: var(--gold); font-weight: 700; margin-top: 8px;">{{ user.best_kills | default(0) }}</div>
  </div>
  <div class="glass-card">
    <div class="muted small">Your Best Damage</div>
    <div style="font-size: 2rem; color: var(--cyan-glow); font-weight: 700; margin-top: 8px;">{{ user.best_damage | default(0) }}</div>
  </div>
</div>

<div class="row">
  <div class="col-lg-6 mb-4">
    <div class="glass-card">
      <h3 class="neon-title mb-3">Quick Actions</h3>
      <div style="display: grid; gap: 8px;">
        <a href="/add_stats" class="btn-neon" style="text-align: center;">ğŸ“¤ Upload Match Record</a>
        <a href="/join_practice" class="btn-neon" style="text-align: center;">âœ… Mark Attendance</a>
        <a href="/leaderboard" class="btn-ghost" style="text-align: center;">ğŸ† View Leaderboard</a>
        <a href="/graphs" class="btn-ghost" style="text-align: center;">ğŸ“ˆ Team Analytics</a>
      </div>
    </div>
  </div>

  {% if user.role == "admin" %}
  <div class="col-lg-6 mb-4">
    <div class="glass-card">
      <h3 class="neon-title mb-3">âš™ï¸ Admin Controls</h3>
      <div style="display: grid; gap: 8px;">
        <a href="/add_player" class="btn-neon" style="text-align: center;">â• Add Player</a>
        <a href="/manage_players" class="btn-neon" style="text-align: center;">ğŸ‘¥ Manage Players</a>
        <a href="/proofs" class="btn-ghost" style="text-align: center;">ğŸ–¼ï¸ Match Proofs</a>
        <a href="/activity_log" class="btn-ghost" style="text-align: center;">ğŸ“‹ Activity Log</a>
        <a href="/announcement" class="btn-ghost" style="text-align: center;">ğŸ“¢ Post Announcement</a>
        <a href="/change_password" class="btn-ghost" style="text-align: center;">ğŸ” Change Password</a>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<div class="row mt-2">
  <div class="col-lg-6 mb-4">
    <div class="glass-card">
      <h3 class="neon-title mb-3">Team Kills Ranking</h3>
      <canvas id="dashKillsChart" style="max-height: 300px;"></canvas>
    </div>
  </div>
  <div class="col-lg-6 mb-4">
    <div class="glass-card">
      <h3 class="neon-title mb-3">Win Rate Distribution</h3>
      <canvas id="dashWinChart" style="max-height: 300px;"></canvas>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// fetch report data into dashboard charts
async function loadDashCharts(){
    const res = await fetch('/api/report');
    const data = await res.json();
    const names = data.map(p=>p.name);
    const kills = data.map(p=>p.kills);
    const winrate = data.map(p=>p.winrate);

    new Chart(document.getElementById('dashKillsChart'),{
        type:'bar',
        data:{labels:names,datasets:[{label:'Total Kills',data:kills,backgroundColor:'rgba(40, 167, 69, 0.6)'}]},
        options:{responsive:true,maintainAspectRatio:false}
    });
    new Chart(document.getElementById('dashWinChart'),{
        type:'pie',
        data:{labels:names,datasets:[{label:'Win Rate',data:winrate}]},
        options:{responsive:true,maintainAspectRatio:false}
    });
}
loadDashCharts();

// enable tooltips used elsewhere
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
  return new bootstrap.Tooltip(tooltipTriggerEl);
});
</script>
{% endblock %}
